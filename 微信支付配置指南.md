# 微信支付配置指南

## 🚨 当前状态
- **开发模式**: 已启用模拟支付功能
- **生产环境**: 需要配置真实微信支付参数

## 🔧 开发阶段使用模拟支付

### 当前配置
```javascript
// app.js 中的配置
developmentMode: true  // 开发阶段使用模拟支付
```

### 模拟支付功能
- ✅ 跳过真实微信支付流程
- ✅ 自动生成订单数据
- ✅ 模拟支付成功状态
- ✅ 清空购物车
- ✅ 跳转到个人中心

## 🏭 生产环境配置步骤

### 1. 申请微信支付商户号
1. 登录 [微信支付商户平台](https://pay.weixin.qq.com)
2. 完成商户资质认证
3. 获取以下信息：
   - `mch_id`: 商户号
   - `apikey`: API密钥

### 2. 小程序配置
1. 登录 [微信公众平台](https://mp.weixin.qq.com)
2. 在"微信支付"中关联商户号
3. 配置支付域名

### 3. 修改代码配置

#### 步骤1: 更新 app.js 配置
```javascript
this.globalData = {
  // 生产环境配置
  developmentMode: false,  // 关闭开发模式
  
  // 替换为真实配置
  appid: 'wx你的真实appid',
  mch_id: '你的真实商户号',
  apikey: '你的真实API密钥',
  
  // 其他配置...
}
```

#### 步骤2: 配置云函数环境
1. 上传并部署 `pay` 云函数
2. 确保云函数有网络访问权限
3. 配置云函数环境变量（如需要）

#### 步骤3: 配置支付回调
```javascript
// 在 orders.js 中更新回调地址
notify_url: 'https://你的域名/wxpay/notify'
```

### 4. 测试流程
1. 使用真实微信账号测试
2. 测试小额支付（如0.01元）
3. 验证订单状态更新
4. 检查支付回调处理

## 🔒 安全注意事项

### API密钥安全
- ❌ 不要将API密钥硬编码在前端
- ✅ 建议将敏感配置放在云函数中
- ✅ 使用环境变量管理密钥

### 建议的安全配置
```javascript
// 云函数中的配置方式
const config = {
  appid: process.env.WECHAT_APPID,
  mch_id: process.env.WECHAT_MCH_ID,
  apikey: process.env.WECHAT_API_KEY
}
```

## 📋 部署检查清单

### 开发环境 ✅
- [x] 模拟支付功能正常
- [x] 订单生成正确
- [x] 购物车清空
- [x] 页面跳转正常

### 生产环境 ⏳
- [ ] 获取微信支付商户号
- [ ] 配置真实appid和密钥
- [ ] 部署pay云函数
- [ ] 配置支付域名
- [ ] 测试真实支付流程
- [ ] 关闭开发模式

## 🆘 常见问题

### Q: 支付时提示"请重新点击支付"
**A**: 这是因为当前使用的是测试配置，需要：
1. 确认 `developmentMode: true` 启用模拟支付
2. 或配置真实的微信支付参数

### Q: 如何切换到真实支付？
**A**: 修改 `app.js` 中的配置：
```javascript
developmentMode: false,  // 关闭模拟支付
// 并配置真实的支付参数
```

### Q: 云函数调用失败
**A**: 检查：
1. 云函数是否正确部署
2. 网络权限是否开启
3. 参数格式是否正确

## 📞 技术支持
- [微信支付开发文档](https://pay.weixin.qq.com/wiki/doc/api/index.html)
- [小程序支付接入指南](https://developers.weixin.qq.com/miniprogram/dev/api/payment/wx.requestPayment.html)