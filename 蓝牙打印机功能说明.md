# 蓝牙打印机功能实现说明

## 功能概述
为订单管理页面添加了蓝牙打印机连接和自动打印订单功能，以及新订单提醒功能。

## 主要功能

### 1. 蓝牙打印机连接
- **搜索设备**: 自动搜索附近的蓝牙打印机设备（支持名称包含"打印"、"Print"或"POS"的设备）
- **连接管理**: 支持连接和断开蓝牙打印机
- **状态显示**: 实时显示打印机连接状态

### 2. 订单打印功能
- **自动打印**: 在发货前提示是否打印订单
- **格式化输出**: 订单信息格式化为适合打印的格式，包括：
  - 订单标题
  - 客户信息（姓名、电话、地址）
  - 订单详情（商品、数量、价格）
  - 总价和备注
  - 订单时间
- **ESC/POS指令**: 使用标准的热敏打印机指令格式

### 3. 新订单提醒
- **实时监控**: 每30秒检查一次新订单
- **多种提醒方式**:
  - 设备震动
  - 提示音
  - 弹窗通知
- **自动启停**: 页面加载时自动开始监控，页面卸载时停止

## 文件修改说明

### 1. bgManage.js
- 添加蓝牙相关数据属性
- 实现蓝牙设备搜索、连接、断开功能
- 添加订单打印功能
- 实现新订单监控和提醒
- 集成打印确认到发货流程

### 2. bgManage.wxml
- 添加蓝牙打印机控制面板
- 添加设备选择弹窗
- 显示连接状态和控制按钮

### 3. bgManage.wxss
- 添加蓝牙控制面板样式
- 设备选择弹窗样式
- 响应式设计，适配不同屏幕尺寸

## 使用说明

### 初次使用
1. 打开订单管理页面
2. 点击"搜索打印机"按钮
3. 从弹窗中选择要连接的打印机
4. 连接成功后状态显示为"已连接"

### 打印订单
1. 在"已支付"订单列表中点击"发货"按钮
2. 系统会弹出确认框询问是否打印订单
3. 选择"确定"后自动打印订单并更新订单状态

### 新订单提醒
- 系统会自动监控新订单
- 有新订单时会震动、播放提示音并显示通知

## 技术要点

### 蓝牙权限
需要在小程序中申请蓝牙权限：
- `wx.openBluetoothAdapter()` - 初始化蓝牙适配器
- `wx.startBluetoothDevicesDiscovery()` - 开始搜索设备
- `wx.createBLEConnection()` - 创建BLE连接

### 打印格式
使用ESC/POS指令集：
- `\x1B\x40` - 初始化打印机
- `\x1B\x61\x01` - 居中对齐
- `\x1D\x21\x11` - 设置字体大小
- `\x0A` - 换行

### 数据转换
字符串转ArrayBuffer用于蓝牙传输：
```javascript
function stringToArrayBuffer(str) {
  const buffer = new ArrayBuffer(str.length);
  const view = new Uint8Array(buffer);
  for (let i = 0; i < str.length; i++) {
    view[i] = str.charCodeAt(i);
  }
  return buffer;
}
```

## 注意事项

1. **设备兼容性**: 确保打印机支持ESC/POS指令集
2. **权限申请**: 首次使用需要用户授权蓝牙权限
3. **连接稳定性**: 建议在打印前检查连接状态
4. **电量管理**: 长时间监控新订单会消耗电量，可考虑优化检查频率

## 后续优化建议

1. 添加打印设置页面，支持自定义打印模板
2. 支持多种打印机品牌的指令集
3. 添加打印历史记录
4. 优化新订单检查频率，支持推送通知
5. 添加打印预览功能