# 自动发货功能测试说明

## 功能概述
已实现自动发货系统，可以自动处理已支付订单的打印和发货流程，避免重复打印。

## 核心功能
1. **自动检测待发货订单**：每30秒检查一次已支付但未发货的订单
2. **防重复打印机制**：通过`printed`字段记录打印状态，避免重复打印
3. **严格的发货条件**：**只有已打印的订单才能自动发货**，未打印订单不会自动发货
4. **自动发货状态更新**：已打印订单自动更新状态为"配送中"
5. **UI控制开关**：提供自动发货和自动打印的独立开关控制

## 测试步骤

### 1. 界面测试
- 打开后台管理页面 (`bgManage`)
- 查看是否显示"🚚 自动发货设置"面板
- 测试"自动发货"和"自动打印"开关是否正常工作

### 2. 自动发货流程测试
1. **准备测试数据**：
   - 确保数据库中有已支付但未发货的订单 (`paySuccess: true, sending: false`)
   
2. **启用自动发货**：
   - 打开"自动发货"开关
   - 观察控制台日志，应显示"自动发货已启用"

3. **观察自动处理**：
   - 等待30秒，系统会自动检查待发货订单
   - 查看控制台日志：
     ```
     检查待发货订单...
     找到 X 个待发货订单
     处理订单自动发货: [订单ID]
     ```

### 3. 自动打印测试
1. **连接蓝牙打印机**：
   - 确保蓝牙打印机已连接
   - 启用"自动打印"开关

2. **测试自动打印**：
   - 系统检测到待发货订单时会自动打印
   - 打印成功后会在订单中记录 `printed: true` 和 `printTime`

### 4. 防重复打印测试
1. **手动发货测试**：
   - 对已打印的订单点击"发货"按钮
   - 应提示"该订单已打印，是否直接发货？"
   - 选择"确定"应直接发货，不再打印

2. **自动发货重复检查**：
   - 已打印的订单不会再次触发打印
   - 但仍会自动更新发货状态

### 5. 未打印订单保护测试
1. **打印机未连接场景**：
   - 断开蓝牙打印机连接
   - 启用自动发货但禁用自动打印
   - 观察控制台日志应显示：
     ```
     ⚠️ 订单 [ID] 未打印且无法自动打印（打印机未连接或自动打印已禁用），跳过自动发货
     💡 提示：该订单需要手动打印后才能发货
     ```
   - 确认订单状态不会自动更新为发货状态

2. **自动打印禁用场景**：
   - 连接蓝牙打印机但禁用自动打印
   - 未打印的订单应保持待发货状态
   - 需要手动打印后才能自动发货

## 关键代码位置

### 数据字段
- `autoShippingEnabled`: 自动发货开关状态
- `autoPrintEnabled`: 自动打印开关状态
- `autoShippingInterval`: 自动检查定时器

### 核心函数
- `startAutoShipping()`: 启动自动发货检查
- `stopAutoShipping()`: 停止自动发货检查
- `checkPendingOrders()`: 检查待发货订单
- `processAutoShipping(order)`: 处理单个订单的自动发货
- `autoPrintOrder(orderData)`: 自动打印订单
- `printOrderWithStatus(orderData)`: 带状态记录的打印

### UI控制
- `toggleAutoShipping(e)`: 切换自动发货开关
- `toggleAutoPrint(e)`: 切换自动打印开关

## 注意事项
1. 自动发货功能只在后台管理页面激活时运行
2. 页面隐藏或卸载时会自动停止检查，避免资源浪费
3. 打印功能需要蓝牙打印机连接，无打印机时会跳过打印直接发货
4. 所有操作都有详细的控制台日志记录，便于调试

## 预期效果
- **严格控制发货条件**：只有已打印的订单才能自动发货，确保订单处理的完整性
- 管理员无需手动点击发货，系统自动处理已打印的已支付订单
- 避免重复打印，节省纸张和时间
- 未打印订单会被保护，不会意外发货，需要手动处理
- 提高发货效率，减少人工操作错误
- 保持订单状态的准确性和及时性